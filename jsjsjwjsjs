-- DELTA 注入器专属适配：优化 HttpGet 调用+框架加载
local function loadFramework()
    -- DELTA 兼容的框架加载（避免跨域/超时问题）
    local success, WindUI = pcall(function()
        return loadstring(game:HttpGetAsync("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua", true))()
    end)
    if not success then
        -- DELTA 原生通知（替代 SetCore）
        game.StarterGui:SetCoreGuiEnabled(Enum.CoreGuiType.All, true)
        game.Players.LocalPlayer:SendNotification({
            Title = "框架加载失败",
            Text = "请检查网络，或手动复制链接到浏览器下载后重试",
            Duration = 6
        })
        return nil
    end
    return WindUI
end

local WindUI = loadFramework()
if not WindUI then return end

-- DELTA 兼容的全局变量（避免内存泄露）
getgenv().WindUI = WindUI
local LocalPlayer = game.Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid", 10)
local RootPart = Character:WaitForChild("HumanoidRootPart", 10)

-- DELTA 专属角色监听（防止角色重生失效）
LocalPlayer.CharacterAdded:Connect(function(newChar)
    Character = newChar
    Humanoid = newChar:WaitForChild("Humanoid", 10)
    RootPart = newChar:WaitForChild("HumanoidRootPart", 10)
end)

-- 简化初始弹窗（DELTA 加载速度优化）
WindUI:Popup({
    Title = "DELTA 专属脚本",
    Content = "玩家: " .. LocalPlayer.Name .. "\n注入器: DELTA",
    Buttons = {
        {
            Title = "关闭",
            Callback = function() WindUI:Destroy() end
        },
        {
            Title = "启动功能",
            Callback = function() createMainUI() end,
            Variant = "Primary"
        }
    },
    Icon = "rbxassetid://4483345998" -- DELTA 支持的内置图标
})

-- 主UI创建（DELTA 内存优化：减少嵌套+简化渲染）
function createMainUI()
    local MainWindow = WindUI:CreateWindow({
        Title = "w 超级脚本",
        Size = UDim2.fromOffset(500, 380), -- 适配 DELTA 窗口渲染
        Theme = "Dark",
        SideBarWidth = 180,
        HideSearchBar = true, -- 关闭搜索栏减少内存占用
        OnClose = function() MainWindow:Hide() end -- DELTA 不支持销毁，仅隐藏
    })

    -- DELTA 兼容的窗口按钮（简化样式避免渲染冲突）
    MainWindow:EditOpenButton({
        Title = "w 脚本",
        Color = ColorSequence.new(Color3.new(1,0,0), Color3.new(0,1,0)),
        Draggable = true,
        StrokeThickness = 1 -- 减少渲染压力
    })

    -- ==================== 核心功能区（DELTA 必生效） ====================
    local CharTab = MainWindow:Tab({ Title = "人物功能", Icon = "user" })
    
    -- 1. 基础属性（DELTA 直接调用，无延迟）
    CharTab:Section({ Title = "基础设置" })
    CharTab:Slider({
        Title = "移动速度",
        Min = 16,
        Max = 180,
        Default = 16,
        Callback = function(val)
            if Humanoid then Humanoid.WalkSpeed = val end
        end
    })
    CharTab:Slider({
        Title = "跳跃高度",
        Min = 50,
        Max = 180,
        Default = 50,
        Callback = function(val)
            if Humanoid then Humanoid.JumpPower = val end
        end
    })

    -- 2. 生存功能（DELTA 无冲突逻辑）
    CharTab:Section({ Title = "生存增强" })
    CharTab:Toggle({
        Title = "无敌模式",
        Default = false,
        Callback = function(state)
            if Humanoid then
                Humanoid.MaxHealth = state and math.huge or 100
                Humanoid.Health = state and math.huge or 100
            end
        end
    })
    CharTab:Toggle({
        Title = "自动回血",
        Default = false,
        Callback = function(state)
            if state then
                spawn(function()
                    while state do
                        task.wait(1)
                        if Humanoid and Humanoid.Health < Humanoid.MaxHealth then
                            Humanoid.Health = math.min(Humanoid.Health + 15, Humanoid.MaxHealth)
                        end
                    end
                end)
            end
        end
    })

    -- 3. 移动功能（DELTA 按键监听优化）
    CharTab:Section({ Title = "特殊移动" })
    local flyEnabled = false
    CharTab:Toggle({
        Title = "自由飞行",
        Default = false,
        Callback = function(state)
            flyEnabled = state
            if state then
                spawn(function()
                    while flyEnabled do
                        task.wait(0.01)
                        if RootPart then
                            local uis = game:GetService("UserInputService")
                            local dir = Vector3.new()
                            if uis:IsKeyDown(Enum.KeyCode.W) then dir += RootPart.CFrame.LookVector end
                            if uis:IsKeyDown(Enum.KeyCode.S) then dir -= RootPart.CFrame.LookVector end
                            if uis:IsKeyDown(Enum.KeyCode.Space) then dir += Vector3.new(0,1,0) end
                            if uis:IsKeyDown(Enum.KeyCode.LeftControl) then dir -= Vector3.new(0,1,0) end
                            RootPart.Velocity = dir.Unit * 70
                        end
                    end
                    if Humanoid then Humanoid.PlatformStand = false end
                end)
                Humanoid.PlatformStand = true
            else
                flyEnabled = false
                if Humanoid then Humanoid.PlatformStand = false end
            end
        end
    })

    -- 4. XAHUB 功能（DELTA 兼容的 loadstring）
    CharTab:Section({ Title = "第三方脚本" })
    CharTab:Button({
        Title = "加载 XAHUB",
        Color = Color3.new(0.8, 0.2, 0.8),
        Callback = function()
            -- DELTA 专属 loadstring（避免权限问题）
            local success, result = pcall(function()
                return loadstring(game:HttpGetAsync("https://pastebin.com/raw/h8nC0fLb", true))()
            end)
            LocalPlayer:SendNotification({
                Title = success and "加载成功" or "加载失败",
                Text = success and "XAHUB 已启动" or "错误：" .. tostring(result),
                Duration = 4
            })
        end
    })

    -- 5. 快速传送（DELTA 无依赖功能）
    CharTab:Button({
        Title = "点击传送工具",
        Callback = function()
            local tool = Instance.new("Tool")
            tool.Name = "传送工具"
            tool.RequiresHandle = false
            tool.Activated:Connect(function()
                local mouse = LocalPlayer:GetMouse()
                if mouse.Hit and RootPart then
                    RootPart.CFrame = CFrame.new(mouse.Hit.Position + Vector3.new(0, 2, 0))
                end
            end)
            tool.Parent = LocalPlayer.Backpack
            LocalPlayer:SendNotification({ Text = "传送工具已放入背包", Duration = 3 })
        end
    })

    -- DELTA 加载成功通知
    LocalPlayer:SendNotification({
        Title = "启动成功",
        Text = "脚本已适配 DELTA 注入器，可正常使用",
        Duration = 3
    })
end

-- DELTA 心跳保活（防止被注入器回收）
spawn(function()
    while true do
        task.wait(8)
        pcall(function()
            if getgenv().WindUI and getgenv().WindUI.Window then
                getgenv().WindUI.Window:Show()
            end
        end)
    end
end)
