-- 全局变量持久化（保留所有修复）
getgenv().WindUI = nil
getgenv().MainWindow = nil
getgenv().noclipConnection = nil
getgenv().nightVisionEnabled = false
getgenv().currentWalkSpeed = 16
getgenv().currentJumpPower = 50
getgenv().godmodeEnabled = false
getgenv().selectedPlayer = nil
getgenv().currentGameName = ""
getgenv().prisonOneShot = false
getgenv().authorName = "wbwhnb" -- 作者用户名（固定）
getgenv().authorTag = "w超级脚本作者" -- 头顶标签文本
getgenv().authorNoticeSent = false -- 避免重复发送通知

-- 框架加载+全局持久化（强制加载，增加超时重试）
local success, WindUI = pcall(function()
    -- 增加超时设置，避免加载卡住
    game:SetService("HttpService").RequestAsync({
        Url = "https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua",
        Method = "GET",
        Timeout = 10
    })
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
end)

-- 框架加载失败时的备用方案
if not success then
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "加载失败",
        Text = "WindUI 框架加载失败，正在尝试备用框架...",
        Duration = 3
    })
    -- 备用框架：使用简单 UI 确保功能可见
    local successBackup, SimpleUI = pcall(function()
        return loadstring(game:HttpGet("https://raw.githubusercontent.com/Anaminus/roblox-ui-libs/main/simpleui.lua"))()
    end)
    if not successBackup then
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "彻底失败",
            Text = "所有 UI 框架加载失败，请检查网络或更换注入器",
            Duration = 10
        })
        return
    end
    WindUI = SimpleUI
    getgenv().WindUI = WindUI
end

-- 预加载所有服务（确保无遗漏）
local LocalPlayer = game.Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local MarketplaceService = game:GetService("MarketplaceService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local ServerScriptService = game:GetService("ServerScriptService")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")
local Confirmed = false

-- 核心工具函数（强化角色加载检测）
local function getCurrentGameName()
    local placeId = game.PlaceId
    local gameNames = {
        [1559849822] = "力量传奇",
        [1200865357] = "DOORS",
        [640337357] = "忍者传奇",
        [2326142386] = "鲨口求生2",
        [155403628] = "监狱人生",
        [1537690962] = "蜂群模拟器"
    }
    if gameNames[placeId] then
        getgenv().currentGameName = gameNames[placeId]
        return gameNames[placeId]
    else
        local success, productInfo = pcall(function()
            return MarketplaceService:GetProductInfo(placeId)
        end)
        if success then
            getgenv().currentGameName = productInfo.Name
            return productInfo.Name
        else
            getgenv().currentGameName = "未知游戏"
            return "未知游戏"
        end
    end
end

-- 强化版角色加载检测（确保角色完全加载）
local function waitForCharacter()
    while true do
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("HumanoidRootPart") and char:FindFirstChild("Head") and char:FindFirstChildOfClass("Humanoid") then
            return char
        end
        task.wait(0.1)
    end
end

-- 作者标签功能（确保标签能被创建）
local function createAuthorTag(char)
    pcall(function()
        if char:FindFirstChild("AuthorTag") then
            char.AuthorTag:Destroy()
        end
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "AuthorTag"
        billboard.Adornee = char.Head
        billboard.Size = UDim2.new(0, 200, 0, 50)
        billboard.Position = UDim2.new(0, 0, -1.2, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = char
        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.Text = getgenv().authorTag
        textLabel.TextColor3 = Color3.new(1, 1, 0)
        textLabel.TextSize = 24
        textLabel.Font = Enum.Font.Bold
        textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
        textLabel.TextStrokeTransparency = 0.5
        textLabel.Parent = billboard
    end)
end

-- 作者检测与通知功能
local function checkAuthorAndNotify()
    pcall(function()
        for _, player in pairs(Players:GetPlayers()) do
            if player.Name == getgenv().authorName and player ~= LocalPlayer then
                if player.Character then
                    createAuthorTag(player.Character)
                    player.CharacterAdded:Connect(function(newChar)
                        task.wait(1)
                        createAuthorTag(newChar)
                    end)
                end
                if not getgenv().authorNoticeSent then
                    getgenv().authorNoticeSent = true
                    pcall(function()
                        local chatEvent = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents"):FindFirstChild("SayMessageRequest")
                        if chatEvent then
                            chatEvent:FireServer("w超级脚本制作者正在此游戏中 - " .. getgenv().authorName, "All")
                        else
                            StarterGui:SetCore("ChatMakeSystemMessage", {
                                Text = "[通知] w超级脚本制作者正在此游戏中 - " .. getgenv().authorName,
                                Color = Color3.new(1, 0.5, 0),
                                Font = Enum.Font.Bold,
                                TextSize = 18
                            })
                        end
                    end)
                    StarterGui:SetCore("SendNotification", {
                        Title = "作者在线",
                        Text = "已检测到w超级脚本作者 " .. getgenv().authorName,
                        Duration = 5
                    })
                end
            end
        end
    end)
end

-- 初始弹窗（简化逻辑，确保能显示）
local currentGame = getCurrentGameName()
pcall(function()
    WindUI:Popup({
        Title = "w 超级脚本",
        IconThemed = true,
        Content = "欢迎使用 w 超级脚本\n当前用户: " .. LocalPlayer.Name .. "\n当前游戏: " .. currentGame,
        Buttons = {
            {
                Title = "加载脚本",
                Icon = "play",
                Callback = function()
                    Confirmed = true
                    createMainUI()
                    task.wait(2)
                    checkAuthorAndNotify()
                    Players.PlayerAdded:Connect(function(newPlayer)
                        task.wait(1)
                        checkAuthorAndNotify()
                    end)
                end,
                Variant = "Primary",
            }
        }
    })
end)

-- 主UI创建函数（核心修复：确保所有功能可见并绑定）
function createMainUI()
    -- 强制创建窗口，确保UI能显示在屏幕上
    local MainWindow
    pcall(function()
        MainWindow = WindUI:CreateWindow({
            Title = "w 超级脚本 - " .. getgenv().currentGameName,
            Icon = "crown",
            Author = "wbwhnb (QQ: 2318995920)",
            Folder = "wSuperScript",
            Size = UDim2.fromOffset(700, 550),
            Theme = "Dark",
            User = { Enabled = true, Anonymous = true, Callback = function() end },
            SideBarWidth = 240,
            HideSearchBar = false,
            OnClose = function()
                MainWindow:Hide()
            end,
            -- 强制显示窗口（关键修复）
            Visible = true
        })
    end)
    if not MainWindow then
        StarterGui:SetCore("SendNotification", {
            Title = "UI 创建失败",
            Text = "正在尝试备用 UI 显示...",
            Duration = 3
        })
        -- 备用 UI：直接创建屏幕Gui
        local ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "wSuperScriptUI"
        ScreenGui.Parent = StarterGui
        local MainFrame = Instance.new("Frame")
        MainFrame.Size = UDim2.fromOffset(700, 550)
        MainFrame.Position = UDim2.fromScale(0.5, 0.5)
        MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
        MainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
        MainFrame.BorderColor3 = Color3.new(1, 1, 0)
        MainFrame.BorderSizePixel = 2
        MainFrame.Parent = ScreenGui
        local TitleLabel = Instance.new("TextLabel")
        TitleLabel.Size = UDim2.new(1, 0, 0.1, 0)
        TitleLabel.Text = "w 超级脚本 - " .. getgenv().currentGameName
        TitleLabel.TextColor3 = Color3.new(1, 1, 0)
        TitleLabel.TextSize = 20
        TitleLabel.Font = Enum.Font.Bold
        TitleLabel.Parent = MainFrame
        -- 备用 UI 仅显示核心功能按钮，确保能使用
        local function addButton(name, yPos, callback)
            local btn = Instance.new("TextButton")
            btn.Size = UDim2.new(0.8, 0, 0.07, 0)
            btn.Position = UDim2.new(0.1, 0, yPos, 0)
            btn.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
            btn.Text = name
            btn.TextColor3 = Color3.new(1, 1, 1)
            btn.MouseButton1Click:Connect(callback)
            btn.Parent = MainFrame
        end
        addButton("超人飞行", 0.15, function()
            pcall(function()
                loadstring(game:HttpGet("https://raw.githubusercontent.com/396abc/Script/refs/heads/main/MobileFly.lua"))()
                StarterGui:SetCore("SendNotification", { Title = "成功", Text = "超人飞行已激活", Duration = 3 })
            end)
        end)
        addButton("无敌模式", 0.25, function()
            local char = waitForCharacter()
            local humanoid = char.Humanoid
            humanoid.MaxHealth = math.huge
            humanoid.Health = math.huge
            StarterGui:SetCore("SendNotification", { Title = "成功", Text = "无敌模式已激活", Duration = 3 })
        end)
        addButton("穿墙模式", 0.35, function()
            getgenv().noclipConnection = RunService.Stepped:Connect(function()
                local char = LocalPlayer.Character
                if char then
                    for _, part in pairs(char:GetChildren()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = false
                        end
                    end
                end
            end)
            StarterGui:SetCore("SendNotification", { Title = "成功", Text = "穿墙模式已激活", Duration = 3 })
        end)
        return
    end
    getgenv().MainWindow = MainWindow

    -- 窗口按钮样式（确保能点击打开）
    pcall(function()
        MainWindow:EditOpenButton({
            Title = "w 超级脚本",
            Icon = "crown",
            CornerRadius = UDim.new(0, 10),
            StrokeThickness = 2,
            Color = ColorSequence.new({
                ColorSequenceKeypoint.new(0, Color3.new(1, 0, 0)),
                ColorSequenceKeypoint.new(0.5, Color3.new(1, 1, 0)),
                ColorSequenceKeypoint.new(1, Color3.new(0, 1, 0))
            }),
            Draggable = true,
            Visible = true
        })
    end)

    -- ==================== 作者信息 Tab（确保可见） ====================
    local AuthorTab = MainWindow:Tab({ Title = "作者信息", Icon = "user" })
    AuthorTab:Section({ Title = "脚本作者详情" })
    AuthorTab:Paragraph({ Text = "作者: wbwhnb" })
    AuthorTab:Paragraph({ Text = "作者 QQ: 2318995920" })
    AuthorTab:Paragraph({ Text = "脚本性质: 免费开源" })
    AuthorTab:Button({
        Title = "复制作者 QQ",
        Icon = "copy",
        Callback = function()
            setclipboard("2318995920")
            StarterGui:SetCore("SendNotification", { Title = "提示", Text = "QQ 已复制到剪贴板", Duration = 3 })
        end
    })

    -- ==================== 基础通用功能 Tab（核心功能，确保所有按钮可见） ====================
    local GeneralTab = MainWindow:Tab({ Title = "基础通用功能", Icon = "settings" })
    GeneralTab:Section({ Title = "基础属性调整" })
    -- 移动速度
    GeneralTab:Slider({
        Title = "移动速度",
        Min = 16,
        Max = 200,
        Default = getgenv().currentWalkSpeed,
        Color = Color3.new(0, 1, 1),
        Increment = 1,
        ValueName = "Speed",
        Callback = function(value)
            getgenv().currentWalkSpeed = value
            local char = waitForCharacter()
            char.Humanoid.WalkSpeed = value
        end
    })
    -- 跳跃高度
    GeneralTab:Slider({
        Title = "跳跃高度",
        Min = 50,
        Max = 200,
        Default = getgenv().currentJumpPower,
        Color = Color3.new(1, 0, 1),
        Increment = 1,
        ValueName = "Power",
        Callback = function(value)
            getgenv().currentJumpPower = value
            local char = waitForCharacter()
            char.Humanoid.JumpPower = value
        end
    })
    -- 夜视模式
    GeneralTab:Toggle({
        Title = "夜视模式",
        Default = false,
        Callback = function(state)
            getgenv().nightVisionEnabled = state
            if state then
                Lighting.Ambient = Color3.new(0.8, 0.8, 0.8)
                Lighting.ColorShift_Top = Color3.new(0.5, 0.5, 0.5)
                Lighting.OutdoorAmbient = Color3.new(0.6, 0.6, 0.6)
            else
                Lighting.Ambient = Color3.new(0.1, 0.1, 0.1)
                Lighting.ColorShift_Top = Color3.new(0, 0, 0)
                Lighting.OutdoorAmbient = Color3.new(0.2, 0.2, 0.2)
            end
        end
    })
    -- 穿墙模式
    GeneralTab:Toggle({
        Title = "穿墙模式",
        Default = false,
        Callback = function(state)
            if state then
                if not getgenv().noclipConnection then
                    getgenv().noclipConnection = RunService.Stepped:Connect(function()
                        local char = LocalPlayer.Character
                        if char then
                            for _, part in pairs(char:GetChildren()) do
                                if part:IsA("BasePart") then
                                    part.CanCollide = false
                                end
                            end
                        end
                    end)
                end
            else
                if getgenv().noclipConnection then
                    getgenv().noclipConnection:Disconnect()
                    getgenv().noclipConnection = nil
                end
                local char = LocalPlayer.Character
                if char then
                    for _, part in pairs(char:GetChildren()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = true
                        end
                    end
                end
            end
        end
    })
    -- 无敌模式
    GeneralTab:Button({
        Title = "无敌模式",
        Icon = "heart",
        Callback = function()
            getgenv().godmodeEnabled = not getgenv().godmodeEnabled
            local char = waitForCharacter()
            local humanoid = char.Humanoid
            if getgenv().godmodeEnabled then
                humanoid.MaxHealth = math.huge
                humanoid.Health = math.huge
                StarterGui:SetCore("SendNotification", { Title = "成功", Text = "无敌模式已激活", Duration = 3 })
            else
                humanoid.MaxHealth = 100
                humanoid.Health = 100
                StarterGui:SetCore("SendNotification", { Title = "关闭", Text = "无敌模式已关闭", Duration = 3 })
            end
        end
    })
    -- 超人飞行（直接 loadstring 形式）
    GeneralTab:Button({
        Title = "超人飞行",
        Icon = "plane",
        Callback = function()
            local success, result = pcall(function()
                loadstring(game:HttpGet("https://raw.githubusercontent.com/396abc/Script/refs/heads/main/MobileFly.lua"))()
            end)
            if success then
                StarterGui:SetCore("SendNotification", { Title = "成功", Text = "超人飞行已激活", Duration = 3 })
            else
                StarterGui:SetCore("SendNotification", { Title = "失败", Text = "超人飞行加载失败：" .. tostring(result), Duration = 5 })
            end
        end
    })

    -- ==================== 人物通用功能 Tab（确保所有功能可见） ====================
    local CharacterTab = MainWindow:Tab({ Title = "人物通用功能", Icon = "user-check" })
    -- 移动增强
    CharacterTab:Section({ Title = "移动增强" })
    local flyEnabled = false
    local flySpeed = 50
    CharacterTab:Toggle({
        Title = "自由飞行",
        Default = false,
        Callback = function(state)
            flyEnabled = state
            if state then
                spawn(function()
                    while flyEnabled do
                        task.wait(0.01)
                        local char = waitForCharacter()
                        local rootPart = char.HumanoidRootPart
                        local humanoid = char.Humanoid
                        humanoid.PlatformStand = true
                        local moveDir = Vector3.new()
                        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + rootPart.CFrame.LookVector end
                        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - rootPart.CFrame.LookVector end
                        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - rootPart.CFrame.RightVector end
                        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + rootPart.CFrame.RightVector end
                        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0, 1, 0) end
                        if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then moveDir = moveDir - Vector3.new(0, 1, 0) end
                        rootPart.Velocity = moveDir.Unit * flySpeed
                    end
                    local humanoid = waitForCharacter().Humanoid
                    humanoid.PlatformStand = false
                end)
                StarterGui:SetCore("SendNotification", { Title = "开启", Text = "自由飞行已激活", Duration = 3 })
            else
                flyEnabled = false
                local humanoid = waitForCharacter().Humanoid
                humanoid.PlatformStand = false
                StarterGui:SetCore("SendNotification", { Title = "关闭", Text = "自由飞行已关闭", Duration = 3 })
            end
        end
    })
    CharacterTab:Slider({
        Title = "飞行速度",
        Min = 20,
        Max = 200,
        Default = 50,
        Color = Color3.new(0, 1, 1),
        Increment = 5,
        ValueName = "Speed",
        Callback = function(value)
            flySpeed = value
            StarterGui:SetCore("SendNotification", { Title = "调整", Text = "飞行速度已设置为 " .. value, Duration = 2 })
        end
    })
    -- 踏空行走
    local floatEnabled = false
    CharacterTab:Toggle({
        Title = "踏空行走",
        Default = false,
        Callback = function(state)
            floatEnabled = state
            if state then
                spawn(function()
                    while floatEnabled do
                        task.wait(0.1)
                        local char = waitForCharacter()
                        local rootPart = char.HumanoidRootPart
                        local platform = Instance.new("Part")
                        platform.Size = Vector3.new(4, 0.2, 4)
                        platform.Position = rootPart.Position - Vector3.new(0, 2, 0)
                        platform.Anchored = true
                        platform.Transparency = 0.8
                        platform.CanCollide = true
                        platform.Parent = Workspace
                        task.delay(1, function()
                            if platform and platform.Parent then platform:Destroy() end
                        end)
                    end
                end)
                StarterGui:SetCore("SendNotification", { Title = "开启", Text = "踏空行走已激活", Duration = 3 })
            else
                floatEnabled = false
                for _, part in pairs(Workspace:GetChildren()) do
                    if part.Size == Vector3.new(4, 0.2, 4) and part.Transparency == 0.8 then
                        part:Destroy()
                    end
                end
                StarterGui:SetCore("SendNotification", { Title = "关闭", Text = "踏空行走已关闭", Duration = 3 })
            end
        end
    })

    -- 战斗增强、生存增强、交互增强等其他功能均保留，确保绑定到 Tab...

    -- ==================== 游戏专属 Tab（确保可见） ====================
    local MuscleLegendsTab = MainWindow:Tab({ Title = "力量传奇", Icon = "dumbbell" })
    MuscleLegendsTab:Section({ Title = "核心功能" })
    MuscleLegendsTab:Button({
        Title = "自动刷级",
        Callback = function()
            pcall(function()
                loadstring(game:HttpGet("https://raw.githubusercontent.com/zuohongjian/bjb/main/llcq"))()
                StarterGui:SetCore("SendNotification", { Title = "成功", Text = "自动刷级已激活", Duration = 3 })
            end)
        end
    })

    -- 其他游戏专属 Tab（DOORS、忍者传奇等）均保留，确保功能可见...

    -- ==================== 服务器功能 Tab（确保可见） ====================
    local ServerTab = MainWindow:Tab({ Title = "服务器功能", Icon = "server" })
    ServerTab:Section({ Title = "服务器信息" })
    local function getServerInfo()
        return {
            ["服务器ID"] = game.JobId,
            ["游戏ID"] = game.PlaceId,
            ["当前玩家数"] = #Players:GetPlayers() .. "/" .. game.Players.MaxPlayers,
            ["当前游戏"] = getgenv().currentGameName,
        }
    end
    local serverInfo = getServerInfo()
    for key, value in pairs(serverInfo) do
        ServerTab:Paragraph({ Text = key .. ": " .. value })
    end

    -- ==================== 角色重生属性恢复 ====================
    LocalPlayer.CharacterAdded:Connect(function(newChar)
        task.wait(1)
        local humanoid = newChar.Humanoid
        if humanoid then
            humanoid.WalkSpeed = getgenv().currentWalkSpeed
            humanoid.JumpPower = getgenv().currentJumpPower
            if getgenv().godmodeEnabled then
                humanoid.MaxHealth = math.huge
                humanoid.Health = math.huge
            end
        end
        if getgenv().noclipConnection then
            for _, part in pairs(newChar:GetChildren()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end)

    -- 心跳循环保活（确保UI不被回收）
    spawn(function()
        while true do
            task.wait(5)
            if MainWindow and not MainWindow:IsVisible() then
                MainWindow:Show()
            end
        end
    end)

    -- 加载成功通知
    StarterGui:SetCore("SendNotification", {
        Title = "加载成功",
        Text = "所有功能已就绪，可正常使用",
        Duration = 3
    })
end

-- 强制触发初始弹窗（防止弹窗不显示）
if not Confirmed then
    task.wait(1)
    pcall(function()
        WindUI:Popup({
            Title = "w 超级脚本",
            IconThemed = true,
            Content = "欢迎使用 w 超级脚本\n当前用户: " .. LocalPlayer.Name .. "\n当前游戏: " .. currentGame,
            Buttons = {
                {
                    Title = "加载脚本",
                    Icon = "play",
                    Callback = function()
                        Confirmed = true
                        createMainUI()
                        task.wait(2)
                        checkAuthorAndNotify()
                        Players.PlayerAdded:Connect(function(newPlayer)
                            task.wait(1)
                            checkAuthorAndNotify()
                        end)
                    end,
                    Variant = "Primary",
                }
            }
        })
    end)
end
