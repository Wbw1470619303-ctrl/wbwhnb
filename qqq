-- 全局变量（仅保留核心）
local LocalPlayer = game.Players.LocalPlayer
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local Players = game:GetService("Players")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")

-- 核心工具函数：确保角色加载
local function waitForCharacter()
    while not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") or not LocalPlayer.Character:FindFirstChild("Head") do
        task.wait(0.1)
    end
    return LocalPlayer.Character
end

-- 原生通知函数（不依赖框架）
local function notify(title, text, duration)
    StarterGui:SetCore("SendNotification", {
        Title = title,
        Text = text,
        Duration = duration or 3
    })
end

-- ==================== 作者标识功能（简化版） ====================
local authorName = "wbwhnb"
local authorTagText = "w超级脚本作者"
local authorNoticeSent = false

local function createAuthorTag(char)
    pcall(function()
        if char:FindFirstChild("AuthorTag") then char.AuthorTag:Destroy() end
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "AuthorTag"
        billboard.Adornee = char.Head
        billboard.Size = UDim2.new(0, 200, 0, 50)
        billboard.Position = UDim2.new(0, 0, -1.2, 0)
        billboard.AlwaysOnTop = true
        billboard.Parent = char

        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.Text = authorTagText
        textLabel.TextColor3 = Color3.new(1, 1, 0)
        textLabel.TextSize = 24
        textLabel.Font = Enum.Font.Bold
        textLabel.TextStrokeColor3 = Color3.new(0, 0, 0)
        textLabel.TextStrokeTransparency = 0.5
        textLabel.Parent = billboard
    end)
end

local function checkAuthor()
    pcall(function()
        for _, player in pairs(Players:GetPlayers()) do
            if player.Name == authorName and player ~= LocalPlayer then
                if player.Character then
                    createAuthorTag(player.Character)
                    player.CharacterAdded:Connect(function(newChar)
                        task.wait(1)
                        createAuthorTag(newChar)
                    end)
                end
                if not authorNoticeSent then
                    authorNoticeSent = true
                    notify("作者在线", "已检测到w超级脚本作者 " .. authorName, 5)
                    -- 聊天通知
                    pcall(function()
                        local chatEvent = game:GetService("ReplicatedStorage"):FindFirstChild("DefaultChatSystemChatEvents"):FindFirstChild("SayMessageRequest")
                        if chatEvent then
                            chatEvent:FireServer("w超级脚本制作者正在此游戏中 - " .. authorName, "All")
                        end
                    end)
                end
            end
        end
    end)
end

-- ==================== 核心功能实现 ====================
-- 1. 超人飞行
local function superFly()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/396abc/Script/refs/heads/main/MobileFly.lua"))()
        notify("成功", "超人飞行已激活")
    end)
end

-- 2. 无敌模式
local godmodeEnabled = false
local function toggleGodmode()
    godmodeEnabled = not godmodeEnabled
    local char = waitForCharacter()
    local humanoid = char.Humanoid
    if godmodeEnabled then
        humanoid.MaxHealth = math.huge
        humanoid.Health = math.huge
        humanoid:GetPropertyChangedSignal("Health"):Connect(function()
            if godmodeEnabled then humanoid.Health = math.huge end
        end)
        notify("成功", "无敌模式已激活")
    else
        humanoid.MaxHealth = 100
        humanoid.Health = 100
        notify("关闭", "无敌模式已关闭")
    end
end

-- 3. 穿墙模式
local noclipEnabled = false
local noclipConnection = nil
local function toggleNoclip()
    noclipEnabled = not noclipEnabled
    if noclipEnabled then
        noclipConnection = RunService.Stepped:Connect(function()
            local char = LocalPlayer.Character
            if char then
                for _, part in pairs(char:GetChildren()) do
                    if part:IsA("BasePart") then part.CanCollide = false end
                end
            end
        end)
        notify("成功", "穿墙模式已激活")
    else
        if noclipConnection then
            noclipConnection:Disconnect()
            noclipConnection = nil
        end
        local char = LocalPlayer.Character
        if char then
            for _, part in pairs(char:GetChildren()) do
                if part:IsA("BasePart") then part.CanCollide = true end
            end
        end
        notify("关闭", "穿墙模式已关闭")
    end
end

-- 4. 夜视模式
local nightVisionEnabled = false
local function toggleNightVision()
    nightVisionEnabled = not nightVisionEnabled
    if nightVisionEnabled then
        Lighting.Ambient = Color3.new(0.8, 0.8, 0.8)
        Lighting.ColorShift_Top = Color3.new(0.5, 0.5, 0.5)
        Lighting.OutdoorAmbient = Color3.new(0.6, 0.6, 0.6)
        notify("成功", "夜视模式已激活")
    else
        Lighting.Ambient = Color3.new(0.1, 0.1, 0.1)
        Lighting.ColorShift_Top = Color3.new(0, 0, 0)
        Lighting.OutdoorAmbient = Color3.new(0.2, 0.2, 0.2)
        notify("关闭", "夜视模式已关闭")
    end
end

-- 5. 移动速度调整（快捷版）
local function setSpeed(value)
    local char = waitForCharacter()
    char.Humanoid.WalkSpeed = value
    notify("调整", "移动速度已设置为 " .. value)
end

-- ==================== 原生 UI 创建（100% 可见） ====================
local function createUI()
    -- 创建原生 ScreenGui（不依赖任何外部框架）
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "wSuperScript"
    ScreenGui.Parent = StarterGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- 主窗口框架
    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.fromOffset(300, 400)
    MainFrame.Position = UDim2.fromScale(0.05, 0.5)
    MainFrame.AnchorPoint = Vector2.new(0, 0.5)
    MainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
    MainFrame.BorderColor3 = Color3.new(1, 1, 0)
    MainFrame.BorderSizePixel = 2
    MainFrame.ClipsDescendants = true
    MainFrame.Parent = ScreenGui

    -- 标题栏
    local TitleBar = Instance.new("Frame")
    TitleBar.Size = UDim2.new(1, 0, 0.1, 0)
    TitleBar.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
    TitleBar.Parent = MainFrame

    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Size = UDim2.new(1, 0, 1, 0)
    TitleLabel.Text = "w 超级脚本"
    TitleLabel.TextColor3 = Color3.new(1, 1, 0)
    TitleLabel.TextSize = 18
    TitleLabel.Font = Enum.Font.Bold
    TitleLabel.Parent = TitleBar

    -- 功能按钮创建函数
    local function addButton(name, yPos, callback)
        local Button = Instance.new("TextButton")
        Button.Size = UDim2.new(0.9, 0, 0.08, 0)
        Button.Position = UDim2.new(0.05, 0, yPos, 0)
        Button.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
        Button.Text = name
        Button.TextColor3 = Color3.new(1, 1, 1)
        Button.TextSize = 14
        Button.Font = Enum.Font.Regular
        Button.MouseButton1Click:Connect(callback)
        -- 按钮hover效果
        Button.MouseEnter:Connect(function()
            Button.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
        end)
        Button.MouseLeave:Connect(function()
            Button.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
        end)
        Button.Parent = MainFrame
    end

    -- 添加功能按钮（位置依次排列）
    addButton("超人飞行", 0.15, superFly)
    addButton("无敌模式", 0.25, toggleGodmode)
    addButton("穿墙模式", 0.35, toggleNoclip)
    addButton("夜视模式", 0.45, toggleNightVision)
    addButton("速度+50", 0.55, function() setSpeed(66) end)
    addButton("速度+100", 0.65, function() setSpeed(116) end)
    addButton("恢复默认速度", 0.75, function() setSpeed(16) end)

    -- 窗口拖动功能
    local isDragging = false
    local startPos = Vector2.new()
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = true
            startPos = input.Position - MainFrame.Position.XY
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            MainFrame.Position = UDim2.fromOffset(input.Position.X - startPos.X, input.Position.Y - startPos.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = false
        end
    end)

    return ScreenGui
end

-- ==================== 启动脚本 ====================
-- 等待角色加载后再创建UI
task.spawn(function()
    waitForCharacter()
    -- 创建UI
    local ui = createUI()
    notify("加载成功", "脚本功能已全部就绪")
    -- 检测作者
    checkAuthor()
    -- 监听新玩家加入
    Players.PlayerAdded:Connect(function()
        task.wait(1)
        checkAuthor()
    end)
    -- 角色重生后恢复状态
    LocalPlayer.CharacterAdded:Connect(function(newChar)
        task.wait(1)
        local humanoid = newChar.Humanoid
        if godmodeEnabled then
            humanoid.MaxHealth = math.huge
            humanoid.Health = math.huge
        end
        if noclipEnabled then
            for _, part in pairs(newChar:GetChildren()) do
                if part:IsA("BasePart") then part.CanCollide = false end
            end
        end
    end)
end)
