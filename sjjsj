-- 核心修复：确保框架加载+服务预加载（解决90%运行失败问题）
local success, WindUI = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
end)

if not success then
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "加载失败",
        Text = "WindUI 框架加载失败，请检查网络或更换注入器",
        Duration = 5
    })
    return
end

-- 预加载所有必需服务（避免nil错误）
local LocalPlayer = game.Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local MarketplaceService = game:GetService("MarketplaceService")
local Confirmed = false

-- 修复：兼容移动设备+角色加载检测
local function waitForCharacter()
    while not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") do
        task.wait(0.1)
    end
    return LocalPlayer.Character
end

-- 初始弹窗（修复按钮回调+内容格式）
WindUI:Popup({
    Title = "w 超级脚本",
    IconThemed = true,
    Content = "欢迎使用 MR 附属脚本 MR pio\n当前用户: " .. LocalPlayer.Name,
    Buttons = {
        {
            Title = "取消",
            Callback = function() end,
            Variant = "Secondary",
        },
        {
            Title = "加载脚本",
            Icon = "play",
            Callback = function()
                Confirmed = true
                createMainUI()
            end,
            Variant = "Primary",
        }
    }
})

-- 主UI创建函数（修复语法错误+逻辑优化）
function createMainUI()
    local MainWindow = WindUI:CreateWindow({
        Title = "w 超级脚本",
        Icon = "crown",
        Author = "wbwhnb (QQ: 2318995920)",
        Folder = "wSuperScript",
        Size = UDim2.fromOffset(600, 400),
        Theme = "Dark",
        User = { Enabled = true, Anonymous = true, Callback = function() end },
        SideBarWidth = 220,
        HideSearchBar = false,
    })

    -- 窗口按钮样式（修复颜色序列+圆角）
    MainWindow:EditOpenButton({
        Title = "w 超级脚本",
        Icon = "crown",
        CornerRadius = UDim.new(0, 10),
        StrokeThickness = 2,
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.new(1, 0, 0)),
            ColorSequenceKeypoint.new(0.5, Color3.new(1, 1, 0)),
            ColorSequenceKeypoint.new(1, Color3.new(0, 1, 0))
        }),
        Draggable = true,
    })

    -- ==================== 作者信息 Tab（无依赖，必运行） ====================
    local AuthorTab = MainWindow:Tab({ Title = "作者信息", Icon = "user" })
    AuthorTab:Section({ Title = "脚本作者详情" })
    AuthorTab:Paragraph({ Text = "作者: wbwhnb" })
    AuthorTab:Paragraph({ Text = "作者 QQ: 2318995920" })
    AuthorTab:Paragraph({ Text = "脚本性质: 免费开源" })
    AuthorTab:Button({
        Title = "复制作者 QQ",
        Icon = "copy",
        Callback = function()
            setclipboard("2318995920")
            WindUI:Notify({ Title = "提示", Content = "QQ 已复制到剪贴板", Duration = 3 })
        end
    })

    -- ==================== 通用功能 Tab（核心功能，修复角色依赖） ====================
    local GeneralTab = MainWindow:Tab({ Title = "通用功能", Icon = "settings" })
    GeneralTab:Section({ Title = "基础属性调整" })

    -- 速度调节（修复角色加载检测）
    GeneralTab:Slider({
        Title = "移动速度",
        Min = 16,
        Max = 200,
        Default = 16,
        Color = Color3.new(0, 1, 1),
        Increment = 1,
        ValueName = "Speed",
        Callback = function(value)
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = value
            end
        end
    })

    -- 跳跃高度调节（修复数值类型）
    GeneralTab:Slider({
        Title = "跳跃高度",
        Min = 50,
        Max = 200,
        Default = 50,
        Color = Color3.new(1, 0, 1),
        Increment = 1,
        ValueName = "Power",
        Callback = function(value)
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.JumpPower = value
            end
        end
    })

    -- 夜视模式（修复光照属性）
    local nightVisionEnabled = false
    GeneralTab:Toggle({
        Title = "夜视模式",
        Default = false,
        Callback = function(state)
            nightVisionEnabled = state
            if state then
                Lighting.Ambient = Color3.new(0.8, 0.8, 0.8)
                Lighting.ColorShift_Top = Color3.new(0.5, 0.5, 0.5)
                Lighting.OutdoorAmbient = Color3.new(0.6, 0.6, 0.6)
            else
                Lighting.Ambient = Color3.new(0.1, 0.1, 0.1)
                Lighting.ColorShift_Top = Color3.new(0, 0, 0)
                Lighting.OutdoorAmbient = Color3.new(0.2, 0.2, 0.2)
            end
        end
    })

    -- 穿墙模式（修复连接泄露）
    local noclipConnection = nil
    GeneralTab:Toggle({
        Title = "穿墙模式",
        Default = false,
        Callback = function(state)
            if state then
                if not noclipConnection then
                    noclipConnection = RunService.Stepped:Connect(function()
                        local char = LocalPlayer.Character
                        if char then
                            for _, part in pairs(char:GetChildren()) do
                                if part:IsA("BasePart") then
                                    part.CanCollide = false
                                end
                            end
                        end
                    end)
                end
            else
                if noclipConnection then
                    noclipConnection:Disconnect()
                    noclipConnection = nil
                end
                local char = LocalPlayer.Character
                if char then
                    for _, part in pairs(char:GetChildren()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = true
                        end
                    end
                end
            end
        end
    })

    -- 无敌模式（修复角色克隆逻辑）
    GeneralTab:Button({
        Title = "无敌模式",
        Icon = "heart",
        Callback = function()
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if char and humanoid then
                humanoid.MaxHealth = math.huge
                humanoid.Health = math.huge
                humanoid:GetPropertyChangedSignal("Health"):Connect(function()
                    if humanoid.Health < math.huge then
                        humanoid.Health = math.huge
                    end
                end)
                WindUI:Notify({ Title = "成功", Content = "无敌模式已激活", Duration = 3 })
            else
                WindUI:Notify({ Title = "错误", Content = "角色未加载完成", Duration = 2 })
            end
        end
    })

    -- 点击传送（修复工具创建逻辑）
    GeneralTab:Button({
        Title = "点击传送",
        Icon = "teleport",
        Callback = function()
            local tool = Instance.new("Tool")
            tool.RequiresHandle = false
            tool.Name = "[FE] 点击传送工具"
            tool.Activated:Connect(function()
                local mouse = LocalPlayer:GetMouse()
                local char = waitForCharacter()
                if mouse.Hit and char:FindFirstChild("HumanoidRootPart") then
                    local pos = mouse.Hit.Position + Vector3.new(0, 2.5, 0)
                    char.HumanoidRootPart.CFrame = CFrame.new(pos)
                end
            end)
            tool.Parent = LocalPlayer.Backpack
            WindUI:Notify({ Title = "获取", Content = "传送工具已放入背包", Duration = 2 })
        end
    })

    -- ==================== 简单娱乐功能（无外部依赖，测试用） ====================
    local FunTab = MainWindow:Tab({ Title = "娱乐功能", Icon = "emoji" })
    FunTab:Button({
        Title = "蓝屏特效",
        Callback = function()
            loadstring(game:HttpGet("https://github.com/RunDTM/roblox-bluescreen/raw/main/bsod.lua"))()
            WindUI:Notify({ Title = "开启", Content = "蓝屏特效已激活（大退关闭）", Duration = 3 })
        end
    })
    FunTab:Button({
        Title = "自杀",
        Callback = function()
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.Health = 0
            end
        end
    })

    -- 加载成功通知
    WindUI:Notify({
        Title = "加载成功",
        Content = "脚本已全部加载完成，可正常使用",
        Duration = 3
    })
end
