-- 核心优化：轻量化框架+必要功能保留
local success, WindUI = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
end)

if not success then
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "加载失败",
        Text = "WindUI 框架加载失败，请换网络/注入器",
        Duration = 5
    })
    return
end

-- 全局变量精简（只保留核心）
getgenv().WindUI = WindUI
getgenv().char = game.Players.LocalPlayer.Character or game.Players.LocalPlayer.CharacterAdded:Wait()
getgenv().humanoid = char:WaitForChild("Humanoid")
getgenv().rootPart = char:WaitForChild("HumanoidRootPart")

-- 快速角色加载（避免等待）
local function getChar()
    if not char or not char.Parent then
        char = game.Players.LocalPlayer.CharacterAdded:Wait()
        humanoid = char:WaitForChild("Humanoid")
        rootPart = char:WaitForChild("HumanoidRootPart")
    end
    return char, humanoid, rootPart
end

-- 初始弹窗（简化）
WindUI:Popup({
    Title = "w 超级脚本",
    Content = "当前用户: " .. game.Players.LocalPlayer.Name,
    Buttons = {
        { Title = "取消", Callback = function() end },
        { Title = "加载", Callback = function() createUI() end }
    }
})

-- 主UI创建（去冲突+轻量化）
function createUI()
    local MainWindow = WindUI:CreateWindow({
        Title = "w 超级脚本",
        Size = UDim2.fromOffset(550, 400),
        Theme = "Dark",
        SideBarWidth = 200,
        OnClose = function() MainWindow:Hide() end
    })

    -- 窗口样式（简化）
    MainWindow:EditOpenButton({
        Title = "w 脚本",
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.new(1,0,0)),
            ColorSequenceKeypoint.new(1, Color3.new(0,1,0))
        }),
        Draggable = true
    })

    -- ==================== 核心功能：人物通用（必生效） ====================
    local CharTab = MainWindow:Tab({ Title = "人物功能", Icon = "user-check" })
    
    -- 1. 移动增强
    CharTab:Section({ Title = "移动" })
    CharTab:Slider({
        Title = "移动速度", Min = 16, Max = 200, Default = 16,
        Callback = function(v) getChar().Humanoid.WalkSpeed = v end
    })
    CharTab:Slider({
        Title = "跳跃高度", Min = 50, Max = 200, Default = 50,
        Callback = function(v) getChar().Humanoid.JumpPower = v end
    })

    -- 2. 生存增强
    CharTab:Section({ Title = "生存" })
    CharTab:Toggle({
        Title = "无敌模式", Default = false,
        Callback = function(s)
            local _, hum = getChar()
            hum.MaxHealth = s and math.huge or 100
            hum.Health = s and math.huge or 100
        end
    })
    CharTab:Toggle({
        Title = "自动回血", Default = false,
        Callback = function(s)
            if s then
                spawn(function()
                    while s do
                        task.wait(1)
                        local _, hum = getChar()
                        hum.Health = math.min(hum.Health + 10, hum.MaxHealth)
                    end
                end)
            end
        end
    })

    -- 3. 移动模式
    CharTab:Section({ Title = "特殊移动" })
    CharTab:Toggle({
        Title = "自由飞行", Default = false,
        Callback = function(s)
            if s then
                spawn(function()
                    while s do
                        task.wait(0.01)
                        local _, hum, root = getChar()
                        hum.PlatformStand = true
                        local dir = Vector3.new()
                        local uis = game:GetService("UserInputService")
                        if uis:IsKeyDown(Enum.KeyCode.W) then dir += root.CFrame.LookVector end
                        if uis:IsKeyDown(Enum.KeyCode.S) then dir -= root.CFrame.LookVector end
                        if uis:IsKeyDown(Enum.KeyCode.Space) then dir += Vector3.new(0,1,0) end
                        if uis:IsKeyDown(Enum.KeyCode.LeftControl) then dir -= Vector3.new(0,1,0) end
                        root.Velocity = dir.Unit * 80
                    end
                    getChar().Humanoid.PlatformStand = false
                end)
            end
        end
    })

    -- ==================== 第三方脚本：XAHUB（独立分区） ====================
    local ThirdTab = MainWindow:Tab({ Title = "第三方脚本", Icon = "external-link" })
    ThirdTab:Button({
        Title = "加载 XAHUB",
        Color = Color3.new(0.8,0.2,0.8),
        Callback = function()
            local success = pcall(function()
                loadstring(game:HttpGet("https://pastebin.com/raw/h8nC0fLb", true))()
            end)
            WindUI:Notify({
                Title = success and "成功" or "失败",
                Content = success and "XAHUB 已加载" or "XAHUB 加载失败",
                Duration = 3
            })
        end
    })

    -- ==================== 游戏快速功能（简化） ====================
    local GameTab = MainWindow:Tab({ Title = "游戏功能", Icon = "gamepad" })
    GameTab:Button({
        Title = "点击传送工具",
        Callback = function()
            local tool = Instance.new("Tool")
            tool.Name = "传送工具"
            tool.Activated:Connect(function()
                local mouse = game.Players.LocalPlayer:GetMouse()
                if mouse.Hit then
                    getChar().HumanoidRootPart.CFrame = CFrame.new(mouse.Hit.Position + Vector3.new(0,2,0))
                end
            end)
            tool.Parent = game.Players.LocalPlayer.Backpack
        end
    })

    -- 加载成功通知
    WindUI:Notify({ Title = "成功", Content = "脚本已就绪", Duration = 2 })
end

-- 心跳保活（防止回收）
spawn(function()
    while true do
        task.wait(10)
        if getgenv().WindUI and getgenv().WindUI.Window then
            pcall(function() getgenv().WindUI.Window:Show() end)
        end
    end
end)
