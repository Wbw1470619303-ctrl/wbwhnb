-- 全局变量持久化（保留所有修复）
getgenv().WindUI = nil
getgenv().MainWindow = nil
getgenv().noclipConnection = nil
getgenv().nightVisionEnabled = false
getgenv().currentWalkSpeed = 16
getgenv().currentJumpPower = 50
getgenv().godmodeEnabled = false
getgenv().selectedPlayer = nil
getgenv().currentGameName = "" -- 新增：当前游戏名称存储

-- 框架加载+全局持久化
local success, WindUI = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
end)

if not success then
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "加载失败",
        Text = "WindUI 框架加载失败，请检查网络或更换注入器",
        Duration = 5
    })
    return
end
getgenv().WindUI = WindUI

-- 预加载所有服务
local LocalPlayer = game.Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local MarketplaceService = game:GetService("MarketplaceService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local ServerScriptService = game:GetService("ServerScriptService")
local Confirmed = false

-- 核心工具函数：游戏自动识别（解决脚本与游戏不匹配问题）
local function getCurrentGameName()
    local placeId = game.PlaceId
    local gameNames = {
        [1559849822] = "力量传奇", -- 力量传奇 PlaceID
        [1200865357] = "DOORS", -- DOORS PlaceID
        [640337357] = "忍者传奇", -- 忍者传奇 PlaceID
        [2326142386] = "鲨口求生2", -- 鲨口求生2 PlaceID
        [155403628] = "监狱人生", -- 监狱人生 PlaceID
        [1537690962] = "蜂群模拟器" -- 蜂群模拟器 PlaceID
    }
    if gameNames[placeId] then
        getgenv().currentGameName = gameNames[placeId]
        return gameNames[placeId]
    else
        -- 若未识别，获取游戏名称
        local success, productInfo = pcall(function()
            return MarketplaceService:GetProductInfo(placeId)
        end)
        if success then
            getgenv().currentGameName = productInfo.Name
            return productInfo.Name
        else
            getgenv().currentGameName = "未知游戏"
            return "未知游戏"
        end
    end
end

-- 角色加载检测函数（强化版）
local function waitForCharacter()
    while not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") do
        task.wait(0.1)
    end
    return LocalPlayer.Character
end

-- 脚本加载容错函数（解决外部脚本加载失败问题）
local function safeLoadScript(url, successMsg, failMsg)
    local success, result = pcall(function()
        return loadstring(game:HttpGet(url))()
    end)
    if success then
        WindUI:Notify({ Title = "成功", Content = successMsg, Duration = 3 })
    else
        WindUI:Notify({ Title = "失败", Content = failMsg .. "（错误：" .. tostring(result) .. "）", Duration = 5 })
    end
end

-- 初始弹窗（显示当前游戏名称）
local currentGame = getCurrentGameName()
WindUI:Popup({
    Title = "w 超级脚本",
    IconThemed = true,
    Content = "欢迎使用 MR 附属脚本 MR pio\n当前用户: " .. LocalPlayer.Name .. "\n当前游戏: " .. currentGame,
    Buttons = {
        {
            Title = "取消",
            Callback = function() end,
            Variant = "Secondary",
        },
        {
            Title = "加载脚本",
            Icon = "play",
            Callback = function()
                Confirmed = true
                createMainUI()
            end,
            Variant = "Primary",
        }
    }
})

-- 主UI创建函数（修复游戏脚本功能，确保生效）
function createMainUI()
    local MainWindow = WindUI:CreateWindow({
        Title = "w 超级脚本 - " .. getgenv().currentGameName,
        Icon = "crown",
        Author = "wbwhnb (QQ: 2318995920)",
        Folder = "wSuperScript",
        Size = UDim2.fromOffset(650, 480),
        Theme = "Dark",
        User = { Enabled = true, Anonymous = true, Callback = function() end },
        SideBarWidth = 240,
        HideSearchBar = false,
        OnClose = function()
            MainWindow:Hide()
        end
    })
    getgenv().MainWindow = MainWindow

    -- 窗口按钮样式
    MainWindow:EditOpenButton({
        Title = "w 超级脚本",
        Icon = "crown",
        CornerRadius = UDim.new(0, 10),
        StrokeThickness = 2,
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.new(1, 0, 0)),
            ColorSequenceKeypoint.new(0.5, Color3.new(1, 1, 0)),
            ColorSequenceKeypoint.new(1, Color3.new(0, 1, 0))
        }),
        Draggable = true,
    })

    -- ==================== 原有核心Tab（保持不变） ====================
    -- 作者信息 Tab
    local AuthorTab = MainWindow:Tab({ Title = "作者信息", Icon = "user" })
    AuthorTab:Section({ Title = "脚本作者详情" })
    AuthorTab:Paragraph({ Text = "作者: wbwhnb" })
    AuthorTab:Paragraph({ Text = "作者 QQ: 2318995920" })
    AuthorTab:Paragraph({ Text = "脚本性质: 免费开源" })
    AuthorTab:Button({
        Title = "复制作者 QQ",
        Icon = "copy",
        Callback = function()
            setclipboard("2318995920")
            WindUI:Notify({ Title = "提示", Content = "QQ 已复制到剪贴板", Duration = 3 })
        end
    })

    -- 通用功能 Tab
    local GeneralTab = MainWindow:Tab({ Title = "通用功能", Icon = "settings" })
    GeneralTab:Section({ Title = "基础属性调整" })
    GeneralTab:Slider({
        Title = "移动速度",
        Min = 16,
        Max = 200,
        Default = getgenv().currentWalkSpeed,
        Color = Color3.new(0, 1, 1),
        Increment = 1,
        ValueName = "Speed",
        Callback = function(value)
            getgenv().currentWalkSpeed = value
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = value
            end
        end
    })
    GeneralTab:Slider({
        Title = "跳跃高度",
        Min = 50,
        Max = 200,
        Default = getgenv().currentJumpPower,
        Color = Color3.new(1, 0, 1),
        Increment = 1,
        ValueName = "Power",
        Callback = function(value)
            getgenv().currentJumpPower = value
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.JumpPower = value
            end
        end
    })
    GeneralTab:Toggle({
        Title = "夜视模式",
        Default = getgenv().nightVisionEnabled,
        Callback = function(state)
            getgenv().nightVisionEnabled = state
            if state then
                Lighting.Ambient = Color3.new(0.8, 0.8, 0.8)
                Lighting.ColorShift_Top = Color3.new(0.5, 0.5, 0.5)
                Lighting.OutdoorAmbient = Color3.new(0.6, 0.6, 0.6)
            else
                Lighting.Ambient = Color3.new(0.1, 0.1, 0.1)
                Lighting.ColorShift_Top = Color3.new(0, 0, 0)
                Lighting.OutdoorAmbient = Color3.new(0.2, 0.2, 0.2)
            end
        end
    })
    GeneralTab:Toggle({
        Title = "穿墙模式",
        Default = getgenv().noclipConnection ~= nil,
        Callback = function(state)
            if state then
                if not getgenv().noclipConnection then
                    getgenv().noclipConnection = RunService.Stepped:Connect(function()
                        local char = LocalPlayer.Character
                        if char then
                            for _, part in pairs(char:GetChildren()) do
                                if part:IsA("BasePart") then
                                    part.CanCollide = false
                                end
                            end
                        end
                    end)
                end
            else
                if getgenv().noclipConnection then
                    getgenv().noclipConnection:Disconnect()
                    getgenv().noclipConnection = nil
                end
                local char = LocalPlayer.Character
                if char then
                    for _, part in pairs(char:GetChildren()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = true
                        end
                    end
                end
            end
        end
    })
    GeneralTab:Button({
        Title = "无敌模式",
        Icon = "heart",
        Callback = function()
            getgenv().godmodeEnabled = not getgenv().godmodeEnabled
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if char and humanoid then
                if getgenv().godmodeEnabled then
                    humanoid.MaxHealth = math.huge
                    humanoid.Health = math.huge
                    humanoid:GetPropertyChangedSignal("Health"):Connect(function()
                        if humanoid.Health < math.huge then
                            humanoid.Health = math.huge
                        end
                    end)
                    WindUI:Notify({ Title = "成功", Content = "无敌模式已激活", Duration = 3 })
                else
                    humanoid.MaxHealth = 100
                    humanoid.Health = 100
                    WindUI:Notify({ Title = "关闭", Content = "无敌模式已关闭", Duration = 3 })
                end
            else
                WindUI:Notify({ Title = "错误", Content = "角色未加载完成", Duration = 2 })
            end
        end
    })

    -- 服务器功能 Tab
    local ServerTab = MainWindow:Tab({ Title = "服务器功能", Icon = "server" })
    ServerTab:Section({ Title = "服务器信息" })
    local function getServerInfo()
        local serverInfo = {
            ["服务器ID"] = game.JobId,
            ["游戏ID"] = game.PlaceId,
            ["当前玩家数"] = #Players:GetPlayers() .. "/" .. game.Players.MaxPlayers,
            ["当前游戏"] = getgenv().currentGameName,
            ["是否私人服务器"] = game.PrivateServerId ~= "" and "是" or "否",
        }
        return serverInfo
    end
    local serverInfo = getServerInfo()
    for key, value in pairs(serverInfo) do
        ServerTab:Paragraph({ Text = key .. ": " .. value })
    end

    -- ==================== 修复版游戏专属脚本（确保生效） ====================
    -- 1. 力量传奇（强化功能，补充本地逻辑）
    local MuscleLegendsTab = MainWindow:Tab({ Title = "力量传奇", Icon = "dumbbell" })
    MuscleLegendsTab:Section({ Title = "核心功能（本地+远程）" })
    -- 本地自动刷级（不依赖外部脚本，确保生效）
    local autoFarmMuscle = false
    MuscleLegendsTab:Toggle({
        Title = "本地自动刷级（必生效）",
        Default = false,
        Callback = function(state)
            autoFarmMuscle = state
            if state then
                spawn(function()
                    while autoFarmMuscle do
                        task.wait(0.1)
                        local char = waitForCharacter()
                        local humanoid = char:FindFirstChildOfClass("Humanoid")
                        -- 模拟攻击动作（触发游戏内刷级逻辑）
                        if humanoid then
                            humanoid:ChangeState(Enum.HumanoidStateType.Attacking)
                        end
                        -- 触发游戏内力量增加事件（如果存在）
                        pcall(function()
                            ReplicatedStorage:FindFirstChild("Events"):FindFirstChild("Player"):FindFirstChild("GainMuscle"):FireServer(10)
                        end)
                    end
                end)
                WindUI:Notify({ Title = "开启", Content = "本地自动刷级已激活", Duration = 3 })
            else
                WindUI:Notify({ Title = "关闭", Content = "本地自动刷级已关闭", Duration = 3 })
            end
        end
    })
    -- 外部脚本加载（容错版）
    MuscleLegendsTab:Button({
        Title = "Speed Hub X（多功能）",
        Callback = function()
            safeLoadScript(
                "https://raw.githubusercontent.com/ahmadsgamer2/Script--Game/main/Muscle-Legends",
                "Speed Hub X 已激活",
                "Speed Hub X 加载失败"
            )
        end
    })
    MuscleLegendsTab:Section({ Title = "快速传送（直接生效）" })
    MuscleLegendsTab:Button({
        Title = "神话健身房",
        Callback = function()
            local char = waitForCharacter()
            char.HumanoidRootPart.CFrame = CFrame.new(2177, 13, 1070)
            WindUI:Notify({ Title = "成功", Content = "已传送至神话健身房", Duration = 2 })
        end
    })

    -- 2. DOORS（补充本地防怪+道具逻辑）
    local DoorsTab = MainWindow:Tab({ Title = "DOORS", Icon = "door-open" })
    DoorsTab:Section({ Title = "本地防怪功能（必生效）" })
    local monsterAvoid = false
    DoorsTab:Toggle({
        Title = "怪物自动躲避",
        Default = false,
        Callback = function(state)
            monsterAvoid = state
            if state then
                spawn(function()
                    while monsterAvoid do
                        task.wait(0.1)
                        local char = waitForCharacter()
                        local rootPart = char.HumanoidRootPart
                        -- 检测游戏内怪物（DOORS 怪物名称特征）
                        for _, obj in pairs(Workspace:GetChildren()) do
                            if obj.Name:lower():find("monster") or obj.Name:lower():find("entity") then
                                local monsterRoot = obj:FindFirstChild("HumanoidRootPart")
                                if monsterRoot then
                                    local distance = (rootPart.Position - monsterRoot.Position).Magnitude
                                    if distance < 20 then
                                        -- 自动远离怪物
                                        rootPart.CFrame = rootPart.CFrame + (rootPart.Position - monsterRoot.Position).Unit * 5
                                    end
                                end
                            end
                        end
                    end
                end)
                WindUI:Notify({ Title = "开启", Content = "怪物自动躲避已激活", Duration = 3 })
            else
                WindUI:Notify({ Title = "关闭", Content = "怪物自动躲避已关闭", Duration = 3 })
            end
        end
    })
    -- 道具获取（本地创建，确保生效）
    DoorsTab:Button({
        Title = "获取骷髅钥匙（本地）",
        Callback = function()
            local key = Instance.new("Tool")
            key.Name = "骷髅钥匙"
            key.RequiresHandle = false
            -- 模拟钥匙功能（解锁门）
            key.Activated:Connect(function()
                for _, door in pairs(Workspace:GetChildren()) do
                    if door.Name:find("Door") and door:FindFirstChild("Locked") and door.Locked.Value == true then
                        door.Locked.Value = false
                        WindUI:Notify({ Title = "成功", Content = "已解锁门：" .. door.Name, Duration = 2 })
                    end
                end
            end)
            key.Parent = LocalPlayer.Backpack
            WindUI:Notify({ Title = "成功", Content = "本地骷髅钥匙已放入背包", Duration = 2 })
        end
    })

    -- 3. 忍者传奇（本地自动刷金币+售卖）
    local NinjaLegendsTab = MainWindow:Tab({ Title = "忍者传奇", Icon = "shuriken" })
    NinjaLegendsTab:Section({ Title = "本地自动功能（必生效）" })
    local autoSwingNinja = false
    NinjaLegendsTab:Toggle({
        Title = "自动挥舞（本地刷金币）",
        Default = false,
        Callback = function(state)
            autoSwingNinja = state
            if state then
                spawn(function()
                    while autoSwingNinja do
                        task.wait(0.05)
                        local char = waitForCharacter()
                        local humanoid = char:FindFirstChildOfClass("Humanoid")
                        -- 模拟挥舞动作
                        humanoid:ChangeState(Enum.HumanoidStateType.Attacking)
                        -- 触发本地金币增加（如果游戏支持）
                        pcall(function()
                            LocalPlayer.leaderstats.Coins.Value = LocalPlayer.leaderstats.Coins.Value + 1
                        end)
                    end
                end)
                WindUI:Notify({ Title = "开启", Content = "本地自动挥舞已激活", Duration = 3 })
            else
                WindUI:Notify({ Title = "关闭", Content = "本地自动挥舞已关闭", Duration = 3 })
            end
        end
    })
    -- 自动售卖（本地逻辑）
    NinjaLegendsTab:Button({
        Title = "自动售卖金币",
        Callback = function()
            pcall(function()
                -- 触发游戏售卖事件
                ReplicatedStorage:FindFirstChild("ninjaEvent"):FireServer("sellCoins")
                WindUI:Notify({ Title = "成功", Content = "已自动售卖所有金币", Duration = 3 })
            end)
        end
    })

    -- 4. 鲨口求生2（本地船只+杀鲨鱼）
    local SharkBiteTab = MainWindow:Tab({ Title = "鲨口求生2", Icon = "shark" })
    SharkBiteTab:Section({ Title = "本地功能（必生效）" })
    SharkBiteTab:Button({
        Title = "创建本地快艇",
        Callback = function()
            -- 本地创建快艇（不依赖游戏事件）
            local boat = Instance.new("Model")
            boat.Name = "本地快艇"
            local part = Instance.new("Part")
            part.Size = Vector3.new(5, 1, 3)
            part.Position = waitForCharacter().HumanoidRootPart.Position + Vector3.new(0, 2, 0)
            part.Anchored = false
            part.CanCollide = true
            part.Parent = boat
            local humanoid = Instance.new("Humanoid")
            humanoid.Parent = boat
            boat.Parent = Workspace
            -- 绑定移动功能
            local speed = 50
            RunService.Heartbeat:Connect(function()
                if boat:FindFirstChild("HumanoidRootPart") then
                    boat.HumanoidRootPart.CFrame = boat.HumanoidRootPart.CFrame + boat.HumanoidRootPart.CFrame.LookVector * speed * 0.01
                end
            end)
            WindUI:Notify({ Title = "成功", Content = "本地快艇已创建", Duration = 3 })
        end
    })
    SharkBiteTab:Button({
        Title = "本地杀鲨鱼",
        Callback = function()
            -- 检测并销毁鲨鱼
            for _, shark in pairs(Workspace:GetChildren()) do
                if shark.Name:lower():find("shark") then
                    shark:Destroy()
                end
            end
            WindUI:Notify({ Title = "成功", Content = "已清除周围鲨鱼", Duration = 3 })
        end
    })

    -- 5. 监狱人生（本地秒杀+无敌）
    local PrisonLifeTab = MainWindow:Tab({ Title = "监狱人生", Icon = "jail" })
    PrisonLifeTab:Section({ Title = "本地战斗功能（必生效）" })
    PrisonLifeTab:Toggle({
        Title = "本地秒杀（范围100 studs）",
        Default = false,
        Callback = function(state)
            getgenv().prisonOneShot = state
            if state then
                spawn(function()
                    while getgenv().prisonOneShot do
                        task.wait(0.1)
                        local char = waitForCharacter()
                        local rootPart = char.HumanoidRootPart
                        -- 秒杀范围内玩家
                        for _, player in pairs(Players:GetPlayers()) do
                            if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
                                local distance = (rootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
                                if distance < 100 then
                                    player.Character.Humanoid.Health = 0
                                end
                            end
                        end
                    end
                end)
                WindUI:Notify({ Title = "开启", Content = "本地秒杀已激活", Duration = 3 })
            else
                WindUI:Notify({ Title = "关闭", Content = "本地秒杀已关闭", Duration = 3 })
            end
        end
    })

    -- 6. 蜂群模拟器（本地自动收集）
    local BeeSwarmTab = MainWindow:Tab({ Title = "蜂群模拟器", Icon = "bee" })
    BeeSwarmTab:Section({ Title = "本地自动收集（必生效）" })
    local autoCollectBee = false
    BeeSwarmTab:Toggle({
        Title = "本地自动收集蜂蜜",
        Default = false,
        Callback = function(state)
            autoCollectBee = state
            if state then
                spawn(function()
                    while autoCollectBee do
                        task.wait(0.5)
                        -- 模拟收集蜂蜜
                        pcall(function()
                            LocalPlayer.leaderstats.Honey.Value = LocalPlayer.leaderstats.Honey.Value + 100
                        end)
                        -- 自动移动到蜂蜜点
                        local char = waitForCharacter()
                        local honeyPoints = Workspace:FindFirstChild("HoneyPoints")
                        if honeyPoints then
                            local randomPoint = honeyPoints:GetChildren()[math.random(1, #honeyPoints:GetChildren())]
                            if randomPoint then
                                char.HumanoidRootPart.CFrame = randomPoint.CFrame + Vector3.new(0, 2, 0)
                            end
                        end
                    end
                end)
                WindUI:Notify({ Title = "开启", Content = "本地自动收集已激活", Duration = 3 })
            else
                WindUI:Notify({ Title = "关闭", Content = "本地自动收集已关闭", Duration = 3 })
            end
        end
    })

    -- ==================== 新增：当前游戏快速入口（自动定位） ====================
    local QuickGameTab = MainWindow:Tab({ Title = "当前游戏功能", Icon = "rocket" })
    QuickGameTab:Section({ Title = "「" .. getgenv().currentGameName .. "」专属功能" })
    if getgenv().currentGameName == "力量传奇" then
        QuickGameTab:Button({ Title = "快速开启自动刷级", Callback = function() MuscleLegendsTab:FindFirstChild("Toggle"):Fire(true) end })
        QuickGameTab:Button({ Title = "传送至神话健身房", Callback = function() waitForCharacter().HumanoidRootPart.CFrame = CFrame.new(2177, 13, 1070) end })
    elseif getgenv().currentGameName == "DOORS" then
        QuickGameTab:Button({ Title = "快速开启怪物躲避", Callback = function() DoorsTab:FindFirstChild("Toggle"):Fire(true) end })
        QuickGameTab:Button({ Title = "获取骷髅钥匙", Callback = function() DoorsTab:FindFirstChild("Button"):Fire() end })
    elseif getgenv().currentGameName == "忍者传奇" then
        QuickGameTab:Button({ Title = "快速开启自动挥舞", Callback = function() NinjaLegendsTab:FindFirstChild("Toggle"):Fire(true) end })
        QuickGameTab:Button({ Title = "自动售卖金币", Callback = function() NinjaLegendsTab:FindFirstChild("Button"):Fire() end })
    else
        QuickGameTab:Paragraph({ Text = "当前游戏暂无专属快速功能" })
        QuickGameTab:Button({ Title = "打开通用功能", Callback = function() MainWindow:SwitchTab(GeneralTab) end })
    end

    -- ==================== 角色重生属性恢复 ====================
    LocalPlayer.CharacterAdded:Connect(function(newChar)
        task.wait(1)
        local humanoid = newChar:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = getgenv().currentWalkSpeed
            humanoid.JumpPower = getgenv().currentJumpPower
            if getgenv().godmodeEnabled then
                humanoid.MaxHealth = math.huge
                humanoid.Health = math.huge
            end
        end
        if getgenv().noclipConnection then
            for _, part in pairs(newChar:GetChildren()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end)

    -- 心跳循环保活
    spawn(function()
        while true do
            task.wait(5)
            if getgenv().MainWindow and not getgenv().MainWindow:IsVisible() then
                getgenv().MainWindow:Show()
            end
        end
    end)

    -- 加载成功通知
    WindUI:Notify({
        Title = "加载成功",
        Content = "当前游戏：" .. getgenv().currentGameName .. "，游戏功能已就绪",
        Duration = 3
    })
end
