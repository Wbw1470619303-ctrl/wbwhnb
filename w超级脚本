-- 全局变量持久化（保留之前的修复）
getgenv().WindUI = nil
getgenv().MainWindow = nil
getgenv().noclipConnection = nil
getgenv().nightVisionEnabled = false
getgenv().currentWalkSpeed = 16
getgenv().currentJumpPower = 50
getgenv().godmodeEnabled = false
getgenv().selectedPlayer = nil

-- 框架加载+全局持久化
local success, WindUI = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/Footagesus/WindUI/main/dist/main.lua"))()
end)

if not success then
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "加载失败",
        Text = "WindUI 框架加载失败，请检查网络或更换注入器",
        Duration = 5
    })
    return
end
getgenv().WindUI = WindUI

-- 预加载所有服务
local LocalPlayer = game.Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local MarketplaceService = game:GetService("MarketplaceService")
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local ServerScriptService = game:GetService("ServerScriptService")
local Confirmed = false

-- 角色加载检测函数
local function waitForCharacter()
    while not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") do
        task.wait(0.1)
    end
    return LocalPlayer.Character
end

-- 初始弹窗
WindUI:Popup({
    Title = "w 超级脚本",
    IconThemed = true,
    Content = "欢迎使用 MR 附属脚本 MR pio\n当前用户: " .. LocalPlayer.Name,
    Buttons = {
        {
            Title = "取消",
            Callback = function() end,
            Variant = "Secondary",
        },
        {
            Title = "加载脚本",
            Icon = "play",
            Callback = function()
                Confirmed = true
                createMainUI()
            end,
            Variant = "Primary",
        }
    }
})

-- 主UI创建函数（新增6个游戏专属Tab）
function createMainUI()
    local MainWindow = WindUI:CreateWindow({
        Title = "w 超级脚本",
        Icon = "crown",
        Author = "wbwhnb (QQ: 2318995920)",
        Folder = "wSuperScript",
        Size = UDim2.fromOffset(650, 480),
        Theme = "Dark",
        User = { Enabled = true, Anonymous = true, Callback = function() end },
        SideBarWidth = 240,
        HideSearchBar = false,
        OnClose = function()
            MainWindow:Hide()
        end
    })
    getgenv().MainWindow = MainWindow

    -- 窗口按钮样式
    MainWindow:EditOpenButton({
        Title = "w 超级脚本",
        Icon = "crown",
        CornerRadius = UDim.new(0, 10),
        StrokeThickness = 2,
        Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.new(1, 0, 0)),
            ColorSequenceKeypoint.new(0.5, Color3.new(1, 1, 0)),
            ColorSequenceKeypoint.new(1, Color3.new(0, 1, 0))
        }),
        Draggable = true,
    })

    -- ==================== 原有核心Tab（保持不变） ====================
    -- 作者信息 Tab
    local AuthorTab = MainWindow:Tab({ Title = "作者信息", Icon = "user" })
    AuthorTab:Section({ Title = "脚本作者详情" })
    AuthorTab:Paragraph({ Text = "作者: wbwhnb" })
    AuthorTab:Paragraph({ Text = "作者 QQ: 2318995920" })
    AuthorTab:Paragraph({ Text = "脚本性质: 免费开源" })
    AuthorTab:Button({
        Title = "复制作者 QQ",
        Icon = "copy",
        Callback = function()
            setclipboard("2318995920")
            WindUI:Notify({ Title = "提示", Content = "QQ 已复制到剪贴板", Duration = 3 })
        end
    })

    -- 通用功能 Tab
    local GeneralTab = MainWindow:Tab({ Title = "通用功能", Icon = "settings" })
    GeneralTab:Section({ Title = "基础属性调整" })
    GeneralTab:Slider({
        Title = "移动速度",
        Min = 16,
        Max = 200,
        Default = getgenv().currentWalkSpeed,
        Color = Color3.new(0, 1, 1),
        Increment = 1,
        ValueName = "Speed",
        Callback = function(value)
            getgenv().currentWalkSpeed = value
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = value
            end
        end
    })
    GeneralTab:Slider({
        Title = "跳跃高度",
        Min = 50,
        Max = 200,
        Default = getgenv().currentJumpPower,
        Color = Color3.new(1, 0, 1),
        Increment = 1,
        ValueName = "Power",
        Callback = function(value)
            getgenv().currentJumpPower = value
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.JumpPower = value
            end
        end
    })
    GeneralTab:Toggle({
        Title = "夜视模式",
        Default = getgenv().nightVisionEnabled,
        Callback = function(state)
            getgenv().nightVisionEnabled = state
            if state then
                Lighting.Ambient = Color3.new(0.8, 0.8, 0.8)
                Lighting.ColorShift_Top = Color3.new(0.5, 0.5, 0.5)
                Lighting.OutdoorAmbient = Color3.new(0.6, 0.6, 0.6)
            else
                Lighting.Ambient = Color3.new(0.1, 0.1, 0.1)
                Lighting.ColorShift_Top = Color3.new(0, 0, 0)
                Lighting.OutdoorAmbient = Color3.new(0.2, 0.2, 0.2)
            end
        end
    })
    GeneralTab:Toggle({
        Title = "穿墙模式",
        Default = getgenv().noclipConnection ~= nil,
        Callback = function(state)
            if state then
                if not getgenv().noclipConnection then
                    getgenv().noclipConnection = RunService.Stepped:Connect(function()
                        local char = LocalPlayer.Character
                        if char then
                            for _, part in pairs(char:GetChildren()) do
                                if part:IsA("BasePart") then
                                    part.CanCollide = false
                                end
                            end
                        end
                    end)
                end
            else
                if getgenv().noclipConnection then
                    getgenv().noclipConnection:Disconnect()
                    getgenv().noclipConnection = nil
                end
                local char = LocalPlayer.Character
                if char then
                    for _, part in pairs(char:GetChildren()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = true
                        end
                    end
                end
            end
        end
    })
    GeneralTab:Button({
        Title = "无敌模式",
        Icon = "heart",
        Callback = function()
            getgenv().godmodeEnabled = not getgenv().godmodeEnabled
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if char and humanoid then
                if getgenv().godmodeEnabled then
                    humanoid.MaxHealth = math.huge
                    humanoid.Health = math.huge
                    humanoid:GetPropertyChangedSignal("Health"):Connect(function()
                        if humanoid.Health < math.huge then
                            humanoid.Health = math.huge
                        end
                    end)
                    WindUI:Notify({ Title = "成功", Content = "无敌模式已激活", Duration = 3 })
                else
                    humanoid.MaxHealth = 100
                    humanoid.Health = 100
                    WindUI:Notify({ Title = "关闭", Content = "无敌模式已关闭", Duration = 3 })
                end
            else
                WindUI:Notify({ Title = "错误", Content = "角色未加载完成", Duration = 2 })
            end
        end
    })
    GeneralTab:Button({
        Title = "点击传送",
        Icon = "teleport",
        Callback = function()
            local tool = Instance.new("Tool")
            tool.RequiresHandle = false
            tool.Name = "[FE] 点击传送工具"
            tool.Activated:Connect(function()
                local mouse = LocalPlayer:GetMouse()
                local char = waitForCharacter()
                if mouse.Hit and char:FindFirstChild("HumanoidRootPart") then
                    local pos = mouse.Hit.Position + Vector3.new(0, 2.5, 0)
                    char.HumanoidRootPart.CFrame = CFrame.new(pos)
                end
            end)
            tool.Parent = LocalPlayer.Backpack
            WindUI:Notify({ Title = "获取", Content = "传送工具已放入背包", Duration = 2 })
        end
    })

    -- 娱乐功能 Tab
    local FunTab = MainWindow:Tab({ Title = "娱乐功能", Icon = "emoji" })
    FunTab:Button({
        Title = "蓝屏特效",
        Callback = function()
            loadstring(game:HttpGet("https://github.com/RunDTM/roblox-bluescreen/raw/main/bsod.lua"))()
            WindUI:Notify({ Title = "开启", Content = "蓝屏特效已激活（大退关闭）", Duration = 3 })
        end
    })
    FunTab:Button({
        Title = "自杀",
        Callback = function()
            local char = waitForCharacter()
            local humanoid = char:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.Health = 0
            end
        end
    })

    -- 服务器功能 Tab
    local ServerTab = MainWindow:Tab({ Title = "服务器功能", Icon = "server" })
    ServerTab:Section({ Title = "服务器信息" })
    local function getServerInfo()
        local serverInfo = {
            ["服务器ID"] = game.JobId,
            ["游戏ID"] = game.PlaceId,
            ["当前玩家数"] = #Players:GetPlayers() .. "/" .. game.Players.MaxPlayers,
            ["服务器区域"] = game:GetService("MarketplaceService"):GetProductInfo(game.PlaceId).Location or "未知",
            ["是否私人服务器"] = game.PrivateServerId ~= "" and "是" or "否",
            ["私人服务器所有者"] = game.PrivateServerOwnerId ~= 0 and Players:GetNameFromUserIdAsync(game.PrivateServerOwnerId) or "无"
        }
        return serverInfo
    end
    local serverInfo = getServerInfo()
    for key, value in pairs(serverInfo) do
        ServerTab:Paragraph({ Text = key .. ": " .. value })
    end
    ServerTab:Button({
        Title = "刷新服务器信息",
        Icon = "refresh",
        Callback = function()
            local newServerInfo = getServerInfo()
            ServerTab:ClearSections()
            ServerTab:Section({ Title = "服务器信息" })
            for key, value in pairs(newServerInfo) do
                ServerTab:Paragraph({ Text = key .. ": " .. value })
            end
            WindUI:Notify({ Title = "成功", Content = "服务器信息已刷新", Duration = 2 })
        end
    })
    ServerTab:Section({ Title = "玩家管理" })
    ServerTab:Dropdown({
        Title = "选择玩家",
        Values = function()
            local playerNames = {}
            for _, player in pairs(Players:GetPlayers()) do
                table.insert(playerNames, player.Name)
            end
            return playerNames
        end,
        Default = LocalPlayer.Name,
        Callback = function(selectedPlayerName)
            getgenv().selectedPlayer = Players:FindFirstChild(selectedPlayerName)
        end
    })
    ServerTab:Button({
        Title = "传送至选中玩家",
        Icon = "user-plus",
        Callback = function()
            local targetPlayer = getgenv().selectedPlayer
            if targetPlayer and targetPlayer ~= LocalPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local char = waitForCharacter()
                char.HumanoidRootPart.CFrame = targetPlayer.Character.HumanoidRootPart.CFrame + Vector3.new(0, 2, 0)
                WindUI:Notify({ Title = "成功", Content = "已传送至 " .. targetPlayer.Name, Duration = 2 })
            else
                WindUI:Notify({ Title = "错误", Content = "目标玩家未加载或为自己", Duration = 2 })
            end
        end
    })

    -- ==================== 新增：游戏专属脚本 Tab ====================
    -- 1. 力量传奇脚本 Tab
    local MuscleLegendsTab = MainWindow:Tab({ Title = "力量传奇", Icon = "dumbbell" })
    MuscleLegendsTab:Section({ Title = "核心脚本功能" })
    MuscleLegendsTab:Button({
        Title = "杯脚本（自动刷级）",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/zuohongjian/bjb/main/llcq"))()
            WindUI:Notify({ Title = "加载成功", Content = "杯脚本已激活，自动刷级中", Duration = 3 })
        end
    })
    MuscleLegendsTab:Button({
        Title = "Speed Hub X（多功能）",
        Callback = function()
            loadstring(game:HttpGetAsync("https://raw.githubusercontent.com/ahmadsgamer2/Script--Game/main/Muscle-Legends"))()
            WindUI:Notify({ Title = "加载成功", Content = "Speed Hub X 已激活", Duration = 3 })
        end
    })
    MuscleLegendsTab:Section({ Title = "快速传送" })
    MuscleLegendsTab:Button({
        Title = "出生点",
        Callback = function()
            local char = waitForCharacter()
            char.HumanoidRootPart.CFrame = CFrame.new(7, 3, 108)
        end
    })
    MuscleLegendsTab:Button({
        Title = "冰霜健身房",
        Callback = function()
            local char = waitForCharacter()
            char.HumanoidRootPart.CFrame = CFrame.new(-2543, 13, -410)
        end
    })
    MuscleLegendsTab:Button({
        Title = "神话健身房",
        Callback = function()
            local char = waitForCharacter()
            char.HumanoidRootPart.CFrame = CFrame.new(2177, 13, 1070)
        end
    })

    -- 2. DOORS 脚本 Tab
    local DoorsTab = MainWindow:Tab({ Title = "DOORS", Icon = "door-open" })
    DoorsTab:Section({ Title = "必备功能" })
    DoorsTab:Button({
        Title = "最强汉化脚本",
        Callback = function()
            loadstring(game:HttpGet("https://pastebin.com/raw/65TwT8ja"))()
            WindUI:Notify({ Title = "加载成功", Content = "DOORS 汉化脚本已激活", Duration = 3 })
        end
    })
    DoorsTab:Button({
        Title = "门绘图显示（防怪）",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/cbhlyy/lyycbh/main/doors1"))()
            WindUI:Notify({ Title = "加载成功", Content = "门绘图已显示，注意躲避怪物", Duration = 3 })
        end
    })
    DoorsTab:Button({
        Title = "吸铁石（自动捡物品）",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/MrNeRD0/Doors-Hack/main/MagnetByNerd.lua"))()
            WindUI:Notify({ Title = "加载成功", Content = "吸铁石功能已激活", Duration = 3 })
        end
    })
    DoorsTab:Section({ Title = "道具获取" })
    DoorsTab:Button({
        Title = "骷髅钥匙（解锁所有门）",
        Callback = function()
            local item = game:GetObjects("rbxassetid://11697889137")[1]
            item.Parent = LocalPlayer.Backpack
            WindUI:Notify({ Title = "获取成功", Content = "骷髅钥匙已放入背包", Duration = 2 })
        end
    })
    DoorsTab:Button({
        Title = "紫色手电筒",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/K0t1n/Public/main/Purple%20Flashlight"))()
            WindUI:Notify({ Title = "获取成功", Content = "紫色手电筒已激活", Duration = 2 })
        end
    })

    -- 3. 忍者传奇脚本 Tab
    local NinjaLegendsTab = MainWindow:Tab({ Title = "忍者传奇", Icon = "shuriken" })
    NinjaLegendsTab:Section({ Title = "自动功能" })
    local autoswing = false
    NinjaLegendsTab:Toggle({
        Title = "自动挥舞（刷金币）",
        Default = false,
        Callback = function(state)
            autoswing = state
            if state then
                spawn(function()
                    while autoswing do
                        task.wait()
                        if LocalPlayer:FindFirstChild("ninjaEvent") then
                            LocalPlayer.ninjaEvent:FireServer("swingKatana")
                        else
                            autoswing = false
                            WindUI:Notify({ Title = "错误", Content = "未找到游戏事件，功能关闭", Duration = 2 })
                        end
                    end
                end)
                WindUI:Notify({ Title = "开启成功", Content = "自动挥舞已激活，开始刷金币", Duration = 3 })
            else
                WindUI:Notify({ Title = "关闭成功", Content = "自动挥舞已关闭", Duration = 2 })
            end
        end
    })
    local autosell = false
    NinjaLegendsTab:Toggle({
        Title = "自动售卖（满了就卖）",
        Default = false,
        Callback = function(state)
            autosell = state
            if state then
                spawn(function()
                    while autosell do
                        task.wait(0.1)
                        local char = waitForCharacter()
                        if Workspace:FindFirstChild("sellAreaCircles") and Workspace.sellAreaCircles:FindFirstChild("sellAreaCircle7") then
                            Workspace.sellAreaCircles.sellAreaCircle7.circleInner.CFrame = char.HumanoidRootPart.CFrame
                            task.wait(0.1)
                            Workspace.sellAreaCircles.sellAreaCircle7.circleInner.CFrame = Workspace:FindFirstChild("Part") and Workspace.Part.CFrame or char.HumanoidRootPart.CFrame
                        end
                    end
                end)
                WindUI:Notify({ Title = "开启成功", Content = "自动售卖已激活", Duration = 3 })
            else
                WindUI:Notify({ Title = "关闭成功", Content = "自动售卖已关闭", Duration = 2 })
            end
        end
    })
    NinjaLegendsTab:Button({
        Title = "解锁所有岛屿",
        Callback = function()
            if Workspace:FindFirstChild("islandUnlockParts") then
                for _, v in pairs(Workspace.islandUnlockParts:GetChildren()) do
                    if v:FindFirstChild("islandSignPart") then
                        local char = waitForCharacter()
                        char.HumanoidRootPart.CFrame = v.islandSignPart.CFrame
                        task.wait(0.5)
                    end
                end
                WindUI:Notify({ Title = "成功", Content = "所有岛屿已解锁", Duration = 3 })
            else
                WindUI:Notify({ Title = "错误", Content = "未找到岛屿解锁区域", Duration = 2 })
            end
        end
    })

    -- 4. 鲨口求生2 脚本 Tab
    local SharkBiteTab = MainWindow:Tab({ Title = "鲨口求生2", Icon = "shark" })
    SharkBiteTab:Section({ Title = "免费船只" })
    SharkBiteTab:Dropdown({
        Title = "选择船只",
        Values = { "DuckyBoat", "Jetski", "VikingShip", "CruiseShip", "MilitarySubmarine" },
        Default = "DuckyBoat",
        Callback = function(value)
            local eventsFolder = ReplicatedStorage:FindFirstChild("EventsFolder")
            if eventsFolder and eventsFolder:FindFirstChild("BoatSelection") then
                eventsFolder.BoatSelection.UpdateHostBoat:FireServer(value)
                WindUI:Notify({ Title = "成功", Content = "已选择船只：" .. value, Duration = 2 })
            else
                WindUI:Notify({ Title = "错误", Content = "船只事件未找到", Duration = 2 })
            end
        end
    })
    SharkBiteTab:Section({ Title = "核心功能" })
    SharkBiteTab:Button({
        Title = "自动杀鲨鱼",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/Sw1ndlerScripts/RobloxScripts/main/Misc%20Scripts/sharkbite2.lua", true))()
            WindUI:Notify({ Title = "加载成功", Content = "自动杀鲨鱼已激活", Duration = 3 })
        end
    })
    SharkBiteTab:Button({
        Title = "传送至刷碎片点",
        Callback = function()
            local char = waitForCharacter()
            char.HumanoidRootPart.CFrame = CFrame.new(20, 115, -695)
            WindUI:Notify({ Title = "成功", Content = "已传送至刷碎片点", Duration = 2 })
        end
    })

    -- 5. 监狱人生 脚本 Tab
    local PrisonLifeTab = MainWindow:Tab({ Title = "监狱人生", Icon = "jail" })
    PrisonLifeTab:Section({ Title = "战斗功能" })
    PrisonLifeTab:Button({
        Title = "手里剑秒杀",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/PSXhuge/1/114514/jian"))()
            WindUI:Notify({ Title = "加载成功", Content = "手里剑秒杀已激活", Duration = 3 })
        end
    })
    PrisonLifeTab:Button({
        Title = "无敌模式（别人可见）",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/cbhlyy/lyycbh/main/jianyu4"))()
            WindUI:Notify({ Title = "加载成功", Content = "无敌模式已激活", Duration = 3 })
        end
    })
    PrisonLifeTab:Section({ Title = "趣味功能" })
    PrisonLifeTab:Button({
        Title = "变成钢铁侠",
        Callback = function()
            loadstring(game:HttpGet("https://pastebin.com/raw/7prijqYH"))()
            WindUI:Notify({ Title = "加载成功", Content = "已变成钢铁侠", Duration = 3 })
        end
    })
    PrisonLifeTab:Button({
        Title = "手拿电锯",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/cbhlyy/lyycbh/main/jianyu3", true))()
            WindUI:Notify({ Title = "加载成功", Content = "已获取电锯", Duration = 3 })
        end
    })
    PrisonLifeTab:Section({ Title = "快速传送" })
    PrisonLifeTab:Button({
        Title = "警卫室",
        Callback = function()
            local char = waitForCharacter()
            char.HumanoidRootPart.CFrame = CFrame.new(847.7, 98.96, 2267.39)
        end
    })
    PrisonLifeTab:Button({
        Title = "罪犯复活点",
        Callback = function()
            local char = waitForCharacter()
            char.HumanoidRootPart.CFrame = CFrame.new(-937.59, 93.1, 2063.03)
        end
    })

    -- 6. 蜂群模拟器 脚本 Tab
    local BeeSwarmTab = MainWindow:Tab({ Title = "蜂群模拟器", Icon = "bee" })
    BeeSwarmTab:Section({ Title = "核心功能" })
    BeeSwarmTab:Button({
        Title = "霖溺简易汉化",
        Callback = function()
            loadstring(game:HttpGet("https://shz.al/~HHAKKJA"))()
            WindUI:Notify({ Title = "加载成功", Content = "蜂群模拟器已汉化", Duration = 3 })
        end
    })
    BeeSwarmTab:Button({
        Title = "自动收集（无限制）",
        Callback = function()
            loadstring(game:HttpGet("https://raw.githubusercontent.com/max0mind/lua/main/loader.lua"))()
            WindUI:Notify({ Title = "加载成功", Content = "自动收集已激活", Duration = 3 })
        end
    })
    BeeSwarmTab:Button({
        Title = "传送至蜂蜜场",
        Callback = function()
            local char = waitForCharacter()
            char.HumanoidRootPart.CFrame = CFrame.new(-525, 65, -125)
            WindUI:Notify({ Title = "成功", Content = "已传送至蜂蜜场", Duration = 2 })
        end
    })

    -- ==================== 角色重生属性恢复 ====================
    LocalPlayer.CharacterAdded:Connect(function(newChar)
        task.wait(1)
        local humanoid = newChar:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = getgenv().currentWalkSpeed
            humanoid.JumpPower = getgenv().currentJumpPower
            if getgenv().godmodeEnabled then
                humanoid.MaxHealth = math.huge
                humanoid.Health = math.huge
            end
        end
        if getgenv().noclipConnection then
            for _, part in pairs(newChar:GetChildren()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
        end
    end)

    -- 心跳循环保活
    spawn(function()
        while true do
            task.wait(5)
            if getgenv().MainWindow and not getgenv().MainWindow:IsVisible() then
                getgenv().MainWindow:Show()
            end
        end
    end)

    -- 加载成功通知
    WindUI:Notify({
        Title = "加载成功",
        Content = "脚本已全部加载，包含6款游戏专属功能",
        Duration = 3
    })
end
